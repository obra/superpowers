#!/usr/bin/env node

import fs from 'fs';
import path from 'path';
import os from 'os';
import { fileURLToPath } from 'url';
import * as skillsCore from '../lib/skills-core.js';

// ESM replacement for __dirname
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Paths
const homeDir = os.homedir();
// When running as an extension, we need to locate skills relative to this script
// This script is in .gemini/superpowers-gemini
// So the root is one level up (..)
const extensionRoot = path.resolve(__dirname, '..');
const superpowersSkillsDir = path.join(extensionRoot, 'skills');
// Personal skills still live in the user's home config
const personalSkillsDir = path.join(homeDir, '.gemini', 'skills');
const bootstrapFile = path.join(extensionRoot, '.gemini', 'superpowers-bootstrap.md');

// Utility functions
function printSkill(skillPath, sourceType) {
    const skillFile = path.join(skillPath, 'SKILL.md');
    // Calculate relative path for display
    let relPath;
    if (sourceType === 'personal') {
        relPath = path.relative(personalSkillsDir, skillPath);
    } else {
        relPath = path.relative(superpowersSkillsDir, skillPath);
    }

    // Print skill name with namespace
    if (sourceType === 'personal') {
        console.log(relPath.replace(/\\/g, '/')); // Personal skills are not namespaced
    } else {
        console.log(`superpowers:${relPath.replace(/\\/g, '/')}`); // Superpowers skills get superpowers namespace
    }

    // Extract and print metadata
    const { name, description } = skillsCore.extractFrontmatter(skillFile);

    if (description) console.log(`  ${description}`);
    console.log('');
}

// Commands
function runInstall() {
    console.log('# Installing Superpowers for Gemini CLI');
    console.log('# =======================================');
    console.log('');
    console.log('Follow these steps to install the Superpowers extension:');
    console.log('');
    console.log('## Step 1: Clone or locate the repository');
    console.log('');
    console.log('If you don\'t already have the repository:');
    console.log('```bash');
    console.log('git clone https://github.com/obra/superpowers.git ~/superpowers');
    console.log('cd ~/superpowers');
    console.log('```');
    console.log('');
    console.log('## Step 2: Install the extension');
    console.log('');
    console.log('Run ONE of these commands:');
    console.log('');
    console.log('Option A - Link for development (changes to repo immediately reflected):');
    console.log('```bash');
    console.log('gemini extensions link ~/superpowers');
    console.log('```');
    console.log('');
    console.log('Option B - Install as a regular extension:');
    console.log('```bash');
    console.log('gemini extensions install ~/superpowers');
    console.log('```');
    console.log('');
    console.log('## Step 3: Verify installation');
    console.log('');
    console.log('Check the extension is installed:');
    console.log('```bash');
    console.log('gemini extensions list');
    console.log('```');
    console.log('');
    console.log('You should see "superpowers" in the list.');
    console.log('');
    console.log('## Step 4: Test it');
    console.log('');
    console.log('Start a Gemini session and ask:');
    console.log('"List all available superpowers skills"');
    console.log('');
    console.log('The agent should use the skills system to list available skills.');
    console.log('');
    console.log('## Troubleshooting');
    console.log('');
    console.log('If you see function calling errors:');
    console.log('- Check if hooks were migrated with wrong variables');
    console.log('- Fix: Edit ~/superpowers/hooks/hooks.json');
    console.log('- Replace ${CLAUDE_PLUGIN_ROOT} with ${extensionPath}');
    console.log('');
    console.log('Need help? https://github.com/obra/superpowers/issues');
}

function runFindSkills() {
    console.log('Available skills:');
    console.log('==================');
    console.log('');

    const foundSkills = new Set();

    // Find personal skills first (these take precedence)
    const personalSkills = skillsCore.findSkillsInDir(personalSkillsDir, 'personal', 2);
    for (const skill of personalSkills) {
        const relPath = path.relative(personalSkillsDir, skill.path);
        foundSkills.add(relPath);
        printSkill(skill.path, 'personal');
    }

    // Find superpowers skills (only if not already found in personal)
    const superpowersSkills = skillsCore.findSkillsInDir(superpowersSkillsDir, 'superpowers', 1);
    for (const skill of superpowersSkills) {
        const relPath = path.relative(superpowersSkillsDir, skill.path);
        if (!foundSkills.has(relPath)) {
            printSkill(skill.path, 'superpowers');
        }
    }

    console.log('Usage:');
    console.log('  superpowers-gemini use-skill <skill-name>   # Load a specific skill');
    console.log('');
    console.log('Skill naming:');
    console.log('  Superpowers skills: superpowers:skill-name');
    console.log('  Personal skills: skill-name (from ~/.gemini/skills/)');
    console.log('  Personal skills override superpowers skills when names match.');
    console.log('');
    console.log('Note: All skills are disclosed at session start via bootstrap.');
}

function runBootstrap() {
    console.log('# Superpowers Bootstrap for Gemini');
    console.log('# ================================');
    console.log('');

    // Check for updates
    if (skillsCore.checkForUpdates(extensionRoot)) {
        console.log('## Update Available');
        console.log('');
        console.log('⚠️  Your superpowers installation is behind the latest version.');
        console.log(`To update, run: \`cd ${extensionRoot} && git pull\``);
        console.log('');
        console.log('---');
        console.log('');
    }

    // Show the bootstrap instructions
    if (fs.existsSync(bootstrapFile)) {
        console.log('## Bootstrap Instructions:');
        console.log('');
        try {
            const content = fs.readFileSync(bootstrapFile, 'utf8');
            console.log(content);
        } catch (error) {
            console.log(`Error reading bootstrap file: ${error.message}`);
        }
        console.log('');
        console.log('---');
        console.log('');
    }

    // Run find-skills to show available skills
    console.log('## Available Skills:');
    console.log('');
    runFindSkills();

    console.log('');
    console.log('---');
    console.log('');

    // Load the using-superpowers skill automatically
    console.log('## Auto-loading superpowers:using-superpowers skill:');
    console.log('');
    runUseSkill('superpowers:using-superpowers');

    console.log('');
    console.log('---');
    console.log('');
    console.log('# Bootstrap Complete!');
    console.log('# You now have access to all superpowers skills.');
    console.log('# Use "superpowers-gemini use-skill <skill>" to load and apply skills.');
    console.log('# Remember: If a skill applies to your task, you MUST use it!');
}

function runUseSkill(skillName) {
    if (!skillName) {
        console.log('Usage: superpowers-gemini use-skill <skill-name>');
        console.log('Examples:');
        console.log('  superpowers-gemini use-skill superpowers:brainstorming  # Load superpowers skill');
        console.log('  superpowers-gemini use-skill brainstorming              # Load personal skill (or superpowers if not found)');
        console.log('  superpowers-gemini use-skill my-custom-skill            # Load personal skill');
        return;
    }

    // Handle namespaced skill names
    let actualSkillPath;
    let forceSuperpowers = false;

    if (skillName.startsWith('superpowers:')) {
        // Remove the superpowers: namespace prefix
        actualSkillPath = skillName.substring('superpowers:'.length);
        forceSuperpowers = true;
    } else {
        actualSkillPath = skillName;
    }

    // Remove "skills/" prefix if present
    if (actualSkillPath.startsWith('skills/')) {
        actualSkillPath = actualSkillPath.substring('skills/'.length);
    }

    // Function to find skill file
    function findSkillFile(searchPath) {
        // Check for exact match with SKILL.md
        const skillMdPath = path.join(searchPath, 'SKILL.md');
        if (fs.existsSync(skillMdPath)) {
            return skillMdPath;
        }

        // Check for direct SKILL.md file
        if (searchPath.endsWith('SKILL.md') && fs.existsSync(searchPath)) {
            return searchPath;
        }

        return null;
    }

    // Helper to safely resolve path and find skill
    function findSafeSkillPath(baseDir, relativePath) {
        if (!fs.existsSync(baseDir)) return null;

        const resolvedBase = path.resolve(baseDir);
        const candidatePath = path.resolve(baseDir, relativePath);

        // Security check: Ensure path traversal doesn't escape base directory
        if (!candidatePath.startsWith(resolvedBase + path.sep)) {
            return null;
        }

        return findSkillFile(candidatePath);
    }

    let skillFile = null;

    // If superpowers: namespace was used, only check superpowers skills
    if (forceSuperpowers) {
        skillFile = findSafeSkillPath(superpowersSkillsDir, actualSkillPath);
    } else {
        // First check personal skills directory (takes precedence)
        skillFile = findSafeSkillPath(personalSkillsDir, actualSkillPath);
        if (skillFile) {
            console.log(`# Loading personal skill: ${actualSkillPath}`);
            console.log(`# Source: ${skillFile}`);
            console.log('');
        }

        // If not found in personal, check superpowers skills
        if (!skillFile) {
            skillFile = findSafeSkillPath(superpowersSkillsDir, actualSkillPath);
            if (skillFile) {
                console.log(`# Loading superpowers skill: superpowers:${actualSkillPath}`);
                console.log(`# Source: ${skillFile}`);
                console.log('');
            }
        }
    }

    // If still not found, error
    if (!skillFile) {
        console.log(`Error: Skill not found: ${actualSkillPath}`);
        console.log('');
        console.log('Available skills:');
        runFindSkills();
        return;
    }

    // Extract frontmatter and content using shared core functions
    let content, frontmatter;
    try {
        const fullContent = fs.readFileSync(skillFile, 'utf8');
        const { name, description } = skillsCore.extractFrontmatter(skillFile);
        content = skillsCore.stripFrontmatter(fullContent);
        frontmatter = { name, description };
    } catch (error) {
        console.log(`Error reading skill file: ${error.message}`);
        return;
    }

    // Display skill header with clean info
    const displayName = forceSuperpowers ? `superpowers:${actualSkillPath}` :
                       (skillFile.includes(personalSkillsDir) ? actualSkillPath : `superpowers:${actualSkillPath}`);

    const skillDirectory = path.dirname(skillFile);

    console.log(`# ${frontmatter.name || displayName}`);
    if (frontmatter.description) {
        console.log(`# ${frontmatter.description}`);
    }
    console.log(`# Skill-specific tools and reference files live in ${skillDirectory}`);
    console.log('# ============================================');
    console.log('');

    // Display the skill content (without frontmatter)
    console.log(content);

}

// Main CLI
const command = process.argv[2];
const arg = process.argv[3];

switch (command) {
    case 'install':
        runInstall();
        break;
    case 'bootstrap':
        runBootstrap();
        break;
    case 'use-skill':
        runUseSkill(arg);
        break;
    case 'find-skills':
        runFindSkills();
        break;
    default:
        console.log('Superpowers for Gemini');
        console.log('Usage:');
        console.log('  superpowers-gemini install                # Show installation instructions');
        console.log('  superpowers-gemini bootstrap              # Run complete bootstrap with all skills');
        console.log('  superpowers-gemini use-skill <skill-name> # Load a specific skill');
        console.log('  superpowers-gemini find-skills            # List all available skills');
        console.log('');
        console.log('Examples:');
        console.log('  superpowers-gemini install');
        console.log('  superpowers-gemini bootstrap');
        console.log('  superpowers-gemini use-skill superpowers:brainstorming');
        console.log('  superpowers-gemini use-skill my-custom-skill');
        break;
}
